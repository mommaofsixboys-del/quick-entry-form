<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Quick Entry Form</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: sans-serif; line-height: 1.4; margin: 20px; }
    label { display: block; margin: 10px 0 5px; }
    input, select, textarea { width: 100%; padding: 8px; box-sizing: border-box; }
    .section { display: none; margin-top: 10px; padding: 10px; border: 1px solid #ddd; }
  </style>
</head>
<body>
  <h2>Quick Record Entry</h2>
  <form id="entryForm">
    <!-- Record Type -->
    <label for="rType">Record Type</label>
    <select name="entry.1713856544" id="rType" required>
      <option value="">Select...</option>
      <option value="Expenses">Expenses</option>
      <option value="Mileage">Mileage</option>
      <option value="Income">Income</option>
    </select>

    <!-- Expenses Section -->
    <div class="section" id="sec-expense">
      <label>Date</label>
      <input type="date" name="entry.1045158713" id="expDate" required>
      <label>Amount</label>
      <input type="number" step="0.01" name="entry.1854250654">
      <label>Category</label>
      <select name="entry.754345117" id="categoryDropdown"></select>
      <label>Description</label>
      <textarea name="entry.121839773"></textarea>
    </div>

    <!-- Mileage Section -->
    <div class="section" id="sec-mileage">
      <label>Date</label>
      <input type="date" name="entry.114922785" id="mileDate">
      <label>Vehicle</label>
      <select name="entry.381239062" id="vehicleDropdown"></select>
      <label>Description</label>
      <textarea name="entry.470293168"></textarea>
      <label>Miles</label>
      <input type="number" step="0.1" name="entry.372962443">
    </div>

    <!-- Income Section -->
    <div class="section" id="sec-income">
      <label>Date</label>
      <input type="date" name="entry.1243144726" id="incDate">
      <label>Amount</label>
      <input type="number" step="0.01" name="entry.1110252672">
      <label>Description</label>
      <textarea name="entry.585862880"></textarea>
    </div>

    <button type="submit" style="margin-top: 20px; padding: 10px 20px;">Submit</button>
  </form>

  <script>
    const rType = document.getElementById('rType');

    function setTodayDate(fieldId) {
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, '0');
      const dd = String(today.getDate()).padStart(2, '0');
      document.getElementById(fieldId).value = `${yyyy}-${mm}-${dd}`;
    }

    // Show the correct section based on Record Type
    rType.addEventListener('change', function() {
      document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
      const sel = this.value;
      if (sel === 'Expenses') {
        document.getElementById('sec-expense').style.display = 'block';
        setTodayDate('expDate');
      } else if (sel === 'Mileage') {
        document.getElementById('sec-mileage').style.display = 'block';
        setTodayDate('mileDate');
      } else if (sel === 'Income') {
        document.getElementById('sec-income').style.display = 'block';
        setTodayDate('incDate');
      }
    });

    // Load Category & Vehicle options from Google Sheets
    fetch("https://docs.google.com/spreadsheets/d/e/2PACX-1vTfwdhWSLJu66lkuSd_jA6plZTjbDIre7tQ4OErOtBWlYAZhhafk2A_UK-b2SY2OKgANGVOFk37QKx6/pub?output=csv")
      .then(response => response.text())
      .then(csv => {
        let rows = csv.split("\n").map(r => r.split(","));
        let categories = [];
        let vehicles = [];
        rows.forEach(row => {
          if (row[0] && row[0].trim()) categories.push(row[0].trim());
          if (row[1] && row[1].trim()) vehicles.push(row[1].trim());
        });

        let catSelect = document.getElementById('categoryDropdown');
        catSelect.innerHTML = '<option value="">Select...</option>' + categories.map(c => `<option value="${c}">${c}</option>`).join('');

        let vehSelect = document.getElementById('vehicleDropdown');
        vehSelect.innerHTML = '<option value="">Select...</option>' + vehicles.map(v => `<option value="${v}">${v}</option>`).join('');
      });

    // Handle form submit via fetch (no redirect)
    document.getElementById('entryForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const formData = new FormData(this);

      fetch('https://docs.google.com/forms/d/e/1FAIpQLSfq5k4yrVHmA9jtyUUMcoSUDcjaktRb_D73_JMLFejWKHJ0jQ/formResponse', {
        method: 'POST',
        mode: 'no-cors',
        body: formData
      }).then(() => {
        alert("✅ Your entry was submitted!");
        this.reset();
        document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
        rType.value = "";
      }).catch(err => {
        alert("⚠️ There was an error submitting the form.");
        console.error(err);
      });
    });
  </script>
</body>
</html>
